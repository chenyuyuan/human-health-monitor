通信报文格式

上位机下发报文通用格式：

| 报文头 | 报文长度   | 报文内容 | 报文尾 |
| ------ | ---------- | -------- | ------ |
| 2字节  | 1字节      | N字节    | 2字节  |
| FEFE   | N（0-255） | 报文内容 | AABB   |

 

下位机回复上位机通用指令格式：

| 报文头 | 指令码 | 回复长度   | 回复信息 | 校验和              | 报文尾 |
| ------ | ------ | ---------- | -------- | ------------------- | ------ |
| 2字节  | 1字节  | 1字节      | N字节    | 1字节               | 2字节  |
| FEFE   | 01-06  | N（0-255） | 回复信息 | 回复信息累加取低8位 | AABB   |

 网关号通过ip和port二元组确定，在查询网关号码信息的时候存入数据库。

#### 1. 查询网关信息

指令码**01**

报文**内容**格式

| 指令码 | 校验和              |
| ------ | ------------------- |
| 1字节  | 1字节               |
| 01     | 前面字节累加取低8位 |

 返回格式：
| 报文头 | 指令码 | 回复长度 | 通信类型 | 网关号 | 校验和 | 报文尾 |
| ------ | ------ | -------- | ------ | ------ | ------ | ------ |
| 2字节  | 1字节      | 1字节 | 1字节 | N字节  |1字节|2字节|
| FE FE  | 01     | N+2 | 00/01 | 网关号 | 前面字节累加取低8位 | AA BB  |

> 协议标识:00表示Modbus,01表示AMQP

> 该指令是固定的，上位机发送报文：
>
> | FE FE  | 02       | 01     | 01     | AA BB  |
> | ------ | -------- | ------ | ------ | ------ |
> | 报文头 | 报文长度 | 指令码 | 校验和 | 报文尾 |
>
> 下位机返回指令（假设被询问网关的网关号是02）：
>
> | FE FE  | 01     | 03       | 00       | 02     | 02     | AA BB  |
> | ------ | ------ | -------- | -------- | ------ | ------ | ------ |
> | 报文头 | 指令码 | 数据长度 | 通信类型 | 网关号 | 校验和 | 报文尾 |
>

>  注：我们不考虑IP地址临时变化的问题



#### 2. 注册设备验证

指令码**02**

报文内容格式

| 指令码 | 设备号               | 标识  | 校验和                 |
| ------ | -------------------- | ----- | ---------------------- |
| 1字节  | 5字节                | 1字节 | 1字节                  |
| 02     | 要验证添加的设备地址 | 00/01 | 前面3个字节累加取低8位 |

> 标识表示删除还是添加设备,00表示添加,01表示删除

返回格式：

| 报文头 | 指令码 | 报文长度 | 设备ID | 标识 | 校验和 | 报文尾 |
| ------ | ------ | -------- | ------ | ------ | ------ | ------ |
| 2字节  | 1字节      | 1字节 | 5字节  | 1字节 |1字节|2字节|
| FE FE  | 01     | 06 | 设备ID | 00/01//10/11 | 前面字节累加取低8位 | AA BB  |

> 标识部分:
>
> 第一位表示删除还是添加,0表示添加,1表示删除;
>
> 第二位表示成功还是失败,0表示失败,1表示成功.

> 上位机发送报文示例：
>
> | FE FE  | 07       | 02     | 0A 00 06 03 02      | 18     | AA BB  |
> | ------ | -------- | ------ | ------------------- | ------ | ------ |
> | 报文头 | 数据长度 | 指令码 | 设备ID（A00060302） | 校验和 | 报文尾 |
>
> > 这条命令表示，上位机要验证LoRa通信方式、地址为6的设备是否能够通过01号网关正常通信（如果能够正常通信，说明设备添加成功，下位机向上位机发送响应报文）。
>
>  
>
> 下位机响应报文示例：
>
> | FE FE  | 02     | 06       | 0A 00 06 03 02      | 00/10 | 18     | AA BB  |
> | ------ | ------ | -------- | ------------------- | ----- | ------ | ------ |
> | 报文头 | 指令码 | 数据长度 | 设备ID（A00060302） | 失败  | 校验和 | 报文尾 |
>
> | FE FE  | 02     | 06       | 0A 00 06 03 02      | 01/11 | 18     | AA BB  |
> | ------ | ------ | -------- | ------------------- | ----- | ------ | ------ |
> | 报文头 | 指令码 | 数据长度 | 设备ID（A00060302） | 成功  | 校验和 | 报文尾 |
>



#### 3. 查询指定传感器信息

指令码**03**

报文内容格式

| 指令码 | 设备ID           | 校验和                 |
| ------ | ---------------- | ---------------------- |
| 1字节  | 5字节            | 1字节                  |
| 03     | 要查询的设备编号 | 前面3个字节累加取低8位 |

返回格式：

| 报文头 | 指令码 | 数据长度 | ID长度 | 设备ID           | 时间戳      | 传感器数据长度 | 传感器数据 | 校验和                 |
| ------ | ------ | -------- | ------ | ---------------- | ----------- | -------------- | ---------- | ---------------------- |
| 2字节  | 1字节  | 1字节    | 1字节  | 5字节            | 4字节       | 1字节          | n字节      | 1字节                  |
| FEFE   | 03     | 12+n     | 05     | 要查询的设备编号 | xx xx xx xx | xx             | xx xx      | 前面3个字节累加取低8位 |

>  上位机发送报文示例：
>
> | FE FE  | 07       | 03     | 0A 00 06 03 02      | 18     | AA BB  |
> | ------ | -------- | ------ | ------------------- | ------ | ------ |
> | 报文头 | 数据长度 | 指令码 | 设备ID（A00060302） | 校验和 | 报文尾 |
>
> 下位机响应报文示例：
>
> | FE FE  | 03     | 10       | 05     | 0A 00 06 03 02      | ‭5D 62 44 6A‬ | 04       | xx xx xx xx | 18     | AA BB  |
> | ------ | ------ | -------- | ------ | ------------------- | ----------- | -------- | ----------- | ------ | ------ |
> | 报文头 | 指令码 | 数据长度 | ID长度 | 设备ID（A00060302） | 时间戳      | 数据长度 | 数据        | 校验和 | 报文尾 |

注:传感器数据域规定:

| 传感器类型（在传感器ID中） | 传感器         | 数据格式                                   | ex.  |
| -------------------------- | -------------- | ------------------------------------------ | ---- |
| 01                         | 人体红外传感器 | 环境温度2字节  体温2字节                   |      |
| 02                         | 血压设备       | 心率1字节  收缩压1字节  舒张压1字节        |      |
| 03                         | 血氧设备       | 血氧饱和度                                 |      |
| 04                         | 床垫           | 心跳2字节  呼吸2字节  温度2字节  动作1字节 |      |



#### 4. 查询全部传感器信息

指令码04

报文内容格式

| 指令码 | 校验和   |
| ------ | -------- |
| 1字节  | 1字节    |
| 04     | 固定为05 |

返回格式:

| 报文头 | 指令码 | 数据长度 | ID长度 | 设备ID           | 时间戳      | 传感器数据长度 | 传感器数据 | 校验和                 |
| ------ | ------ | -------- | ------ | ---------------- | ----------- | -------------- | ---------- | ---------------------- |
| 2字节  | 1字节  | 1字节    | 1字节  | 5字节            | 4字节       | 1字节          | n字节      | 1字节                  |
| FEFE   | 04     | 12+n     | 05     | 要查询的设备编号 | xx xx xx xx | xx             | xx xx      | 前面3个字节累加取低8位 |

>  上位机发送报文示例：
>
> | FE FE  | 07       | 04     | 18     | AA BB  |
> | ------ | -------- | ------ | ------ | ------ |
> | 报文头 | 数据长度 | 指令码 | 校验和 | 报文尾 |
>
> 下位机响应报文示例：
>
> | FE FE  | 04     | 10       | 05     | 0A 00 06 03 02      | ‭5D 62 44 6A‬ | 04       | xx xx xx xx | 18     | AA BB  |
> | ------ | ------ | -------- | ------ | ------------------- | ----------- | -------- | ----------- | ------ | ------ |
> | 报文头 | 指令码 | 数据长度 | ID长度 | 设备ID（A00060302） | 时间戳      | 数据长度 | 数据        | 校验和 | 报文尾 |

> 注:与单个查询返回内容相同,但返回数据为每个已有的传感器的当前一条数据

注:传感器数据域规定:

| 传感器类型标号 | 传感器         | 传感器数据格式                             | ex.  |
| -------------- | -------------- | ------------------------------------------ | ---- |
| 01             | 人体红外传感器 | 环境温度2字节  体温2字节                   |      |
| 02             | 血压设备       | 心率1字节  收缩压1字节  舒张压1字节        |      |
| 03             | 血氧设备       | 血氧饱和度                                 |      |
| 04             | 床垫           | 心跳2字节  呼吸2字节  温度2字节  动作1字节 |      |



#### 5.下位机与上位机通信协议更换

指令码**05**

报文**内容**格式

| 指令码 | 协议标识 | 校验和              |
| ------ | -------- | ------------------- |
| 1字节  | 1字节    | 1字节               |
| 05     | 00/01    | 前面字节累加取低8位 |

> 协议标识:00表示Modbus,01表示AMQP

返回格式：

| 报文头 | 指令码 | 回复长度 | 标识  | 校验和              | 报文尾 |
| ------ | ------ | -------- | ----- | ------------------- | ------ |
| 2字节  | 1字节  | 1字节    | 1字节 | 1字节               | 2字节  |
| FE FE  | 05     | XX       | 00/01 | 前面字节累加取低8位 | AA BB  |

标识:00表示失败,01表示成功 

>  该指令是固定的，上位机发送报文：
>
> | FE FE  | 03       | 05     | 00       | 01     | AA BB  |
> | ------ | -------- | ------ | -------- | ------ | ------ |
> | 报文头 | 报文长度 | 指令码 | 协议标识 | 校验和 | 报文尾 |
>
> 下位机返回指令：
>
> | FE FE  | 05     | 02       | 00   | 02     | AA BB  |
> | ------ | ------ | -------- | ---- | ------ | ------ |
> | 报文头 | 指令码 | 数据长度 | 标识 | 校验和 | 报文尾 |

Modbus转AMQP协议下位机发送报文示例：

FE FE 01 05 00 0D 00 00 00 00 00 00 00 00 00 00 00 00 00 00 AA BB

​    第1、2个字节FE FE：报文头

第3个字节01：网关号

第4个字节05：指令码

第5、6两个字节00 0D：数据长度（等价于十进制的13）

第7-19个字节00 00 00 00 00 00 00 00 00 00 00 00 00：补位

第20个字节00：校验和

第21、22个字节AA BB：报文尾

注：1.AMQP更换为Modbus时只需要网关向云平台发起建立socket连接即可自动转为Modbus，无需发送命令

   2.上位机指挥下位机更换协议的功能暂未添加，后续8需要添加，上位机发给下位机的指令格式参考如下：

​     FE FE 04 01（网关号） 05（指令码） 00（补位） 06（校验和） AA BB

​     上面一行的命令含义就是将01号网关的协议转为另一种（上位机通过Modbus协议发送，下位机在接到后就将通信协议转为AMQP，反之亦然，上位机通过AMQP协议发送，下位机在接到后就将通信协议转为Modbus



#### 6.设备信息获取

指令码**06**

报文**内容**格式

| 指令码 | 校验和              |
| ------ | ------------------- |
| 1字节  | 1字节               |
| 06     | 前面字节累加取低8位 |

 返回格式：

| 报文头 | 指令码 | 回复长度 | 网关长度 | 网关号 | ID长度 | 设备ID   | 注册时间 | 校验和              | 报文尾 |
| ------ | ------ | -------- | -------- | ------ | ------ | -------- | -------- | ------------------- | ------ |
| 2字节  | 1字节  | 1字节    | 1字节    | N字节  | 1字节  | 5字节    | 4字节    | 1字节               | 2字节  |
| FE FE  | 06     | N+12     | 01       | 网关号 | 05     | 设备编号 | 时间戳   | 前面字节累加取低8位 | AA BB  |

> 该指令是固定的，上位机发送报文：
>
> | FE FE  | 02       | 06     | 01     | AA BB  |
> | ------ | -------- | ------ | ------ | ------ |
> | 报文头 | 报文长度 | 指令码 | 校验和 | 报文尾 |
>
> 下位机返回指令：
>
> | FE FE  | 06     | 0B       | 02     | 0A 00 06 03 02 | ‭5D 62 44 6A‬ | 02     | AA BB  |
> | ------ | ------ | -------- | ------ | -------------- | ----------- | ------ | ------ |
> | 报文头 | 指令码 | 数据长度 | 网关号 | 设备ID         | 注册时间    | 校验和 | 报文尾 |



#### 7.设备信息修改

指令码**07**

报文**内容**格式

| 指令码 | 设备ID         | 设备名称长度 | 设备名称 | 注册时间 | 绑定对象长度 | 绑定对象 | 校验和              |
| ------ | -------------- | ------------ | -------- | -------- | ------------ | -------- | ------------------- |
| 1字节  | 5字节          | 1字节        | M字节    | 4字节    | 1字节        | X字节    | 1字节               |
| 07     | 0A 00 06 03 02 | 02           | XX XX    | 时间戳   | 02           | XX XX    | 前面字节累加取低8位 |

 返回格式：

| 报文头 | 指令码 | 回复长度 | 设备ID         | 标识  | 校验和              | 报文尾 |
| ------ | ------ | -------- | -------------- | ----- | ------------------- | ------ |
| 2字节  | 1字节  | 1字节    | 5字节          | 1字节 | 1字节               | 2字节  |
| FE FE  | 07     | 07       | 0A 00 06 03 02 | 00/01 | 前面字节累加取低8位 | AA BB  |

> 标识：00表示设备不存在，01表示成功

> 该指令是固定的，上位机发送报文：
>
> | FE FE  | 11       | 07     | 0A 00 06 03 02 | 02           | XX XX    | ‭5D 62 44 6A‬ | 02           | XX XX    | 01     | AA BB  |
> | ------ | -------- | ------ | -------------- | ------------ | -------- | ----------- | ------------ | -------- | ------ | ------ |
> | 报文头 | 报文长度 | 指令码 | 设备ID         | 设备名称长度 | 设备名称 | 注册时间    | 绑定对象长度 | 绑定对象 | 校验和 | 报文尾 |
>
> 下位机返回指令：
>
> | FE FE  | 07     | 07       | 0A 00 06 03 02 | 01   | 02     | AA BB  |
> | ------ | ------ | -------- | -------------- | ---- | ------ | ------ |
> | 报文头 | 指令码 | 数据长度 | 设备ID         | 标识 | 校验和 | 报文尾 |